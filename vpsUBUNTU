#!/bin/bash

# Ask for VPS code
read -p "Enter your VPS code: " vpscode

# Correctly apply VPS code to /etc/hosts
sudo tee /etc/hosts > /dev/null <<EOF
127.0.0.1       localhost ${vpscode}
::1     localhost ip6-localhost ip6-loopback
fe00::  ip6-localnet
ff00::  ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
172.17.0.2      e91e22096dd8
EOF

# Update system and install GNOME + required packages
# Added dbus-x11 which is critical for launching GNOME in VNC
echo "--- Installing packages, this may take a few minutes... ---"
sudo apt-get update && sudo apt-get install -y \
    ubuntu-desktop \
    gnome-session gnome-terminal \
    novnc \
    python3-websockify \
    python3-numpy \
    tightvncserver \
    dbus-x11 \
    htop nano neofetch \
    firefox

# Generate SSL certificate for noVNC
echo "--- Generating SSL certificate... ---"
openssl req -x509 -nodes -newkey rsa:3072 \
    -keyout ~/novnc.pem -out ~/novnc.pem -days 3650 \
    -subj "/C=US/ST=None/L=None/O=NoVNC/CN=localhost"

# Initialize VNC config and set a password
# Note: You will be prompted to enter a VNC password here
echo "--- Initializing VNC Server, please set your password ---"
vncserver :1
vncserver -kill :1

# Backup and create new xstartup file
[ -f ~/.vnc/xstartup ] && mv ~/.vnc/xstartup ~/.vnc/xstartup.bak

# Create a new, more robust xstartup for GNOME
# This version explicitly starts a dbus session, which is the key fix
cat <<EOF > ~/.vnc/xstartup
#!/bin/sh
export XDG_SESSION_TYPE=x11
export DBUS_SESSION_BUS_ADDRESS=\${DBUS_SESSION_BUS_ADDRESS}

# Load system-wide X session startup script if it exists
[ -x /etc/vnc/xstartup ] && exec /etc/vnc/xstartup
[ -r \$HOME/.Xresources ] && xrdb \$HOME/.Xresources

# Launch GNOME session with a dbus-launch wrapper
# This ensures all GNOME components can communicate
dbus-launch --exit-with-session gnome-session &
EOF

# Make the new xstartup script executable
chmod +x ~/.vnc/xstartup

# Start VNC server with a common resolution
# The -localhost flag is a security best practice
echo "--- Starting VNC server... ---"
vncserver -geometry 1920x1080 -localhost :1

# Start noVNC (websockify) in the background
echo "--- Starting noVNC service... ---"
websockify -D --web=/usr/share/novnc/ --cert=\$HOME/novnc.pem 6080 localhost:5901

# Display system info
neofetch

# Output access info
echo "âœ… Setup complete! Access noVNC at https://${vpscode}-6080.csb.app/vnc.html"
echo "ðŸ“Œ VPS code '${vpscode}' has been applied to /etc/hosts."
